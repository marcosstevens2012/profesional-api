import { Injectable } from "@nestjs/common";

// Mock data - same profiles as ProfilesService
const mockProfiles = [
  {
    id: "1",
    userId: "user1",
    title: "Desarrollador Full-Stack",
    description:
      "Especialista en React, Node.js y bases de datos. Más de 5 años creando aplicaciones web modernas.",
    location: "Buenos Aires, Argentina",
    hourlyRate: 15000,
    rating: 4.9,
    reviewCount: 23,
    isActive: true,
    skills: ["React", "Node.js", "PostgreSQL", "TypeScript"],
    experienceYears: 5,
    languages: ["Español", "Inglés"],
    responseTime: "2 horas",
    slug: "juan-perez-dev",
    user: {
      id: "user1",
      name: "Juan Pérez",
      email: "juan@example.com",
      avatarUrl: null,
      isEmailVerified: true,
    },
    services: [
      {
        id: "s1",
        title: "Desarrollo Frontend",
        description: "Aplicaciones React y Next.js",
        basePrice: 20000,
      },
      {
        id: "s2",
        title: "Desarrollo Backend",
        description: "APIs REST con Node.js",
        basePrice: 25000,
      },
    ],
    reviews: [
      {
        id: "r1",
        rating: 5,
        comment:
          "Excelente trabajo, muy profesional y cumplió con todos los tiempos acordados.",
        createdAt: "2024-01-15T10:00:00Z",
        user: { name: "María González" },
      },
    ],
  },
  {
    id: "2",
    userId: "user2",
    title: "Diseñadora UX/UI",
    description:
      "Diseño de experiencias digitales centradas en el usuario. Experta en Figma y prototipado.",
    location: "Córdoba, Argentina",
    hourlyRate: 12000,
    rating: 4.8,
    reviewCount: 18,
    isActive: true,
    skills: ["Figma", "Adobe XD", "Photoshop", "Prototipado"],
    experienceYears: 4,
    languages: ["Español"],
    responseTime: "1 hora",
    slug: "ana-martinez-ux",
    user: {
      id: "user2",
      name: "Ana Martínez",
      email: "ana@example.com",
      avatarUrl: null,
      isEmailVerified: true,
    },
    services: [
      {
        id: "s3",
        title: "Diseño UX/UI",
        description: "Interfaces web y móviles",
        basePrice: 18000,
      },
    ],
    reviews: [
      {
        id: "r2",
        rating: 5,
        comment: "Diseños increíbles, muy creativa y profesional.",
        createdAt: "2024-01-10T14:30:00Z",
        user: { name: "Carlos López" },
      },
    ],
  },
  {
    id: "3",
    userId: "user3",
    title: "Marketing Digital",
    description:
      "Especialista en estrategias de marketing digital, SEO y redes sociales.",
    location: "Rosario, Argentina",
    hourlyRate: 8000,
    rating: 4.7,
    reviewCount: 31,
    isActive: true,
    skills: ["SEO", "Google Ads", "Facebook Ads", "Analytics"],
    experienceYears: 3,
    languages: ["Español", "Inglés"],
    responseTime: "3 horas",
    slug: "luis-rodriguez-marketing",
    user: {
      id: "user3",
      name: "Luis Rodríguez",
      email: "luis@example.com",
      avatarUrl: null,
      isEmailVerified: true,
    },
    services: [
      {
        id: "s4",
        title: "Campaña SEO",
        description: "Optimización para motores de búsqueda",
        basePrice: 15000,
      },
    ],
    reviews: [
      {
        id: "r3",
        rating: 4,
        comment: "Buenos resultados en poco tiempo, recomendado.",
        createdAt: "2024-01-05T09:15:00Z",
        user: { name: "Sandra Díaz" },
      },
    ],
  },
];

@Injectable()
export class SearchService {
  search(params: {
    query: string;
    type: string;
    location?: string;
    category?: string;
  }) {
    // Apply filtering based on search params
    let filteredProfiles = [...mockProfiles];

    if (params.query) {
      const searchTerm = params.query.toLowerCase();
      filteredProfiles = filteredProfiles.filter(
        profile =>
          profile.title.toLowerCase().includes(searchTerm) ||
          profile.description.toLowerCase().includes(searchTerm) ||
          profile.user.name.toLowerCase().includes(searchTerm) ||
          profile.skills.some(skill => skill.toLowerCase().includes(searchTerm))
      );
    }

    if (params.location) {
      filteredProfiles = filteredProfiles.filter(profile =>
        profile.location.toLowerCase().includes(params.location!.toLowerCase())
      );
    }

    if (params.category) {
      filteredProfiles = filteredProfiles.filter(
        profile =>
          profile.skills.some(skill =>
            skill.toLowerCase().includes(params.category!.toLowerCase())
          ) ||
          profile.title.toLowerCase().includes(params.category!.toLowerCase())
      );
    }

    return {
      message: "Search results",
      success: true,
      data: filteredProfiles,
      pagination: {
        page: 1,
        limit: filteredProfiles.length,
        total: filteredProfiles.length,
        totalPages: 1,
        hasNext: false,
        hasPrev: false,
      },
      params,
    };
  }

  getSuggestions(query: string) {
    const suggestions = {
      professionals: mockProfiles
        .filter(
          p =>
            p.title.toLowerCase().includes(query.toLowerCase()) ||
            p.user.name.toLowerCase().includes(query.toLowerCase())
        )
        .slice(0, 5),
      services: [],
      categories: ["Desarrollo", "Diseño", "Marketing", "Consultoría"],
    };

    return {
      message: "Search suggestions",
      data: suggestions,
      query,
    };
  }
}
